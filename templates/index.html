<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Classificador de Emails - AutoU</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /*
            Esta se√ß√£o cont√©m estilos CSS personalizados que complementam o Tailwind CSS.
            S√£o usados para anima√ß√µes e efeitos visuais mais complexos.
        */

        /* Define a fonte padr√£o para todo o corpo do documento. */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Aplica uma anima√ß√£o de fade-in aos cont√™ineres de resultado e erro. */
        .result-box,
        .error-box {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Define a anima√ß√£o 'fadeIn', que faz os elementos aparecerem suavemente. */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
                /* Come√ßa invis√≠vel e um pouco acima. */
            }

            to {
                opacity: 1;
                transform: translateY(0);
                /* Termina totalmente vis√≠vel na posi√ß√£o original. */
            }
        }

        /* Esconde o cont√™iner da chave de API por padr√£o. A visibilidade √© controlada por JavaScript. */
        #api_key_wrapper {
            display: none;
        }

        /* Define a anima√ß√£o 'blob' para os elementos de fundo, criando um efeito de flutua√ß√£o org√¢nica. */
        @keyframes blob {
            0% {
                transform: scale(1) translate(0px, 0px);
            }

            33% {
                transform: scale(1.1) translate(30px, -50px);
            }

            66% {
                transform: scale(0.9) translate(-20px, 20px);
            }

            100% {
                transform: scale(1) translate(0px, 0px);
            }
        }

        /* Define a anima√ß√£o 'twinkle' para os pontos de luz de fundo, simulando estrelas piscando. */
        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }
        }

        /* Adiciona um efeito de reflexo sutil (glassmorphism) na parte superior do card principal. */
        .card-glass::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 35%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.15), transparent);
            border-radius: inherit;
            pointer-events: none;
            /* Garante que o reflexo n√£o interfira com cliques do mouse. */
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-gray-900 via-gray-950 to-black text-gray-100 flex items-start justify-center min-h-screen p-4 sm:p-6 relative py-12 sm:py-20">
    <div class="absolute inset-0 w-full h-full z-0 overflow-hidden">
        <div
            class="absolute top-0 -left-10 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-purple-600 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-[blob_28s_infinite]">
        </div>
        <div
            class="absolute top-0 -right-10 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-blue-500 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-[blob_30s_infinite_reverse]">
        </div>
        <div
            class="absolute bottom-0 left-20 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-cyan-500 rounded-full mix-blend-screen filter blur-3xl opacity-15 animate-[blob_34s_infinite]">
        </div>
        <div
            class="absolute bottom-0 right-20 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-indigo-600 rounded-full mix-blend-screen filter blur-3xl opacity-15 animate-[blob_32s_infinite]">
        </div>
        <div
            class="absolute top-1/3 left-1/3 w-24 h-24 bg-indigo-400 rounded-full mix-blend-screen filter blur-2xl opacity-10 animate-[blob_40s_infinite]">
        </div>
        <div
            class="absolute top-2/3 right-1/3 w-20 h-20 bg-blue-400 rounded-full mix-blend-screen filter blur-2xl opacity-10 animate-[blob_36s_infinite_reverse]">
        </div>
        <div
            class="absolute bottom-1/3 left-1/2 w-16 h-16 bg-cyan-300 rounded-full mix-blend-screen filter blur-2xl opacity-10 animate-[blob_42s_infinite]">
        </div>
        <div
            class="absolute top-1/2 right-1/2 w-16 h-16 bg-purple-400 rounded-full mix-blend-screen filter blur-2xl opacity-10 animate-[blob_38s_infinite_reverse]">
        </div>
        <div
            class="absolute top-[45%] left-[38%] w-10 h-10 bg-purple-500 rounded-full mix-blend-screen filter blur-xl opacity-20 animate-[blob_35s_infinite]">
        </div>
        <div
            class="absolute top-[42%] left-[62%] w-8 h-8 bg-cyan-400 rounded-full mix-blend-screen filter blur-lg opacity-20 animate-[blob_37s_infinite_reverse]">
        </div>
        <div
            class="absolute bottom-[40%] left-[47%] w-12 h-12 bg-blue-500 rounded-full mix-blend-screen filter blur-xl opacity-15 animate-[blob_39s_infinite]">
        </div>
        <div
            class="absolute bottom-[43%] right-[47%] w-9 h-9 bg-indigo-400 rounded-full mix-blend-screen filter blur-lg opacity-20 animate-[blob_41s_infinite_reverse]">
        </div>
        <div class="absolute left-[12%] top-[25%] w-36 h-36 bg-purple-400/30 rounded-full blur-[80px]"></div>
        <div class="absolute left-[8%] top-[50%] w-20 h-20 bg-pink-400/30 rounded-full blur-[50px]"></div>
        <div class="absolute left-[15%] top-[72%] w-28 h-28 bg-blue-400/25 rounded-full blur-[60px]"></div>
        <div class="absolute right-[12%] top-[28%] w-32 h-32 bg-purple-400/30 rounded-full blur-[75px]"></div>
        <div class="absolute right-[9%] top-[52%] w-24 h-24 bg-pink-400/30 rounded-full blur-[55px]"></div>
        <div class="absolute right-[16%] top-[75%] w-40 h-40 bg-blue-400/20 rounded-full blur-[90px]"></div>
        <div class="absolute inset-0">
            <div class="absolute top-10 left-1/4 w-1 h-1 bg-yellow-300 rounded-full animate-[twinkle_4s_infinite]"></div>
            <div class="absolute top-1/3 left-2/3 w-0.5 h-0.5 bg-yellow-200 rounded-full animate-[twinkle_6s_infinite]">
            </div>
            <div class="absolute top-1/2 left-1/5 w-1 h-1 bg-white rounded-full animate-[twinkle_5s_infinite_reverse]">
            </div>
            <div class="absolute bottom-1/3 right-1/4 w-0.5 h-0.5 bg-white rounded-full animate-[twinkle_7s_infinite]">
            </div>
            <div class="absolute bottom-20 left-1/2 w-1 h-1 bg-yellow-100 rounded-full animate-[twinkle_8s_infinite]">
            </div>
            <div class="absolute top-[48%] left-[44%] w-1 h-1 bg-yellow-200 rounded-full animate-[twinkle_9s_infinite]">
            </div>
            <div
                class="absolute top-[52%] left-[56%] w-0.5 h-0.5 bg-white rounded-full animate-[twinkle_10s_infinite_reverse]">
            </div>
            <div class="absolute top-[40%] left-[53%] w-1 h-1 bg-yellow-300 rounded-full animate-[twinkle_11s_infinite]">
            </div>
            <div
                class="absolute top-[57%] left-[46%] w-1 h-1 bg-white rounded-full animate-[twinkle_12s_infinite_reverse]">
            </div>
            <div
                class="absolute top-[62%] left-[51%] w-0.5 h-0.5 bg-yellow-200 rounded-full animate-[twinkle_13s_infinite]">
            </div>
            <div
                class="absolute bottom-[35%] left-[42%] w-1 h-1 bg-white rounded-full animate-[twinkle_14s_infinite_reverse]">
            </div>
            <div
                class="absolute bottom-[37%] right-[42%] w-0.5 h-0.5 bg-yellow-100 rounded-full animate-[twinkle_15s_infinite]">
            </div>
            <div class="absolute top-[5%] left-[15%] w-1 h-1 bg-white rounded-full animate-[twinkle_7s_infinite_reverse]">
            </div>
            <div class="absolute top-[8%] right-[20%] w-1 h-1 bg-yellow-200 rounded-full animate-[twinkle_6s_infinite]">
            </div>
            <div
                class="absolute top-[12%] left-[35%] w-0.5 h-0.5 bg-yellow-100 rounded-full animate-[twinkle_8s_infinite_reverse]">
            </div>
            <div class="absolute top-[18%] right-[30%] w-1 h-1 bg-white rounded-full animate-[twinkle_9s_infinite]"></div>
            <div class="absolute top-[45%] left-[10%] w-1 h-1 bg-yellow-300 rounded-full animate-[twinkle_12s_infinite]">
            </div>
            <div
                class="absolute top-[55%] right-[12%] w-0.5 h-0.5 bg-white rounded-full animate-[twinkle_11s_infinite_reverse]">
            </div>
            <div class="absolute bottom-[10%] left-[20%] w-1 h-1 bg-yellow-200 rounded-full animate-[twinkle_10s_infinite]">
            </div>
            <div
                class="absolute bottom-[15%] right-[25%] w-1 h-1 bg-white rounded-full animate-[twinkle_13s_infinite_reverse]">
            </div>
            <div
                class="absolute bottom-[18%] left-[40%] w-0.5 h-0.5 bg-yellow-100 rounded-full animate-[twinkle_14s_infinite]">
            </div>
            <div
                class="absolute bottom-[22%] right-[40%] w-1 h-1 bg-white rounded-full animate-[twinkle_15s_infinite_reverse]">
            </div>
        </div>
    </div>

    <div
        class="w-full max-w-2xl bg-white/10 backdrop-blur-xl rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.6)] p-6 sm:p-8 space-y-8 border border-white/20 relative z-20 card-glass mb-12 sm:mb-20">
        <header class="text-center space-y-2">
            <h1
                class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 drop-shadow-lg">
                Classificador de Emails
            </h1>
            <p class="text-gray-300 drop-shadow">Uma simula√ß√£o do Case Pr√°tico AutoU üöÄ</p>
        </header>

        <form action="/process" method="POST" enctype="multipart/form-data" class="space-y-6">

            <div>
                <label for="text_input" class="block text-sm font-medium text-gray-200 mb-1">Cole o texto do e-mail
                    aqui:</label>
                <textarea id="text_input" name="text_input" rows="8"
                    class="w-full p-3 rounded-lg border border-gray-700 bg-gray-900/60 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 placeholder-gray-400"
                    placeholder="Ex: Ol√°, gostaria de saber o status do meu pedido 12345.">{{ original_text or '' }}</textarea>
                </div>

            <div class="relative flex items-center">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">OU</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>

            <div>
                <label for="file_input" class="block text-sm font-medium text-gray-200 mb-1">Envie um arquivo (.txt ou
                    .pdf):</label>

                <input type="file" id="file_input" name="file" accept=".txt,.pdf" class="hidden">

                <label for="file_input" class="w-full flex items-center cursor-pointer">
                    <span
                        class="mr-4 py-2 px-4 rounded-lg border-0 text-sm font-semibold bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:opacity-90 transition whitespace-nowrap">
                        Escolher ficheiro
                    </span>
                    <span id="file_name_display" class="text-sm text-gray-400 truncate">
                        Nenhum ficheiro selecionado
                        </span>
                </label>

                <p id="file_feedback" class="text-xs text-gray-400 mt-1 h-4"></p>
            </div>

            <div class="grid sm:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="mode" class="block text-sm font-medium text-gray-200 mb-1">Escolha o modelo de
                        IA:</label>
                    <select id="mode" name="mode"
                        class="w-full p-3 border border-gray-700 bg-gray-900/60 rounded-lg text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="local" {% if selected_mode=='local' or not selected_mode %}selected{% endif %}>
                            Modelo Local (R√°pido e Offline)</option>
                        <option value="gemini" {% if selected_mode=='gemini' %}selected{% endif %}>Google Gemini</option>
                        <option value="openai" {% if selected_mode=='openai' %}selected{% endif %}>OpenAI GPT</option>
                    </select>
                </div>

                <div>
                    <label for="user_name" class="block text-sm font-medium text-gray-200 mb-1">Seu Nome (para
                        assinatura):</label>
                    <input type="text" id="user_name" name="user_name" value="{{ user_name or '' }}"
                        class="w-full p-3 border border-gray-700 bg-gray-900/60 rounded-lg text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        placeholder="Ex: Guilherme">
                    </div>
            </div>

            <div id="api_key_wrapper" class="pt-2">
                <label for="api_key" class="block text-sm font-medium text-gray-200 mb-1">Chave de API:</label>
                <input type="password" id="api_key" name="api_key"
                    class="w-full p-3 border border-gray-700 bg-gray-900/60 rounded-lg text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    placeholder="Cole sua chave de API aqui">
            </div>

            <button type="submit"
                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg 
                 hover:opacity-90 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition duration-150 text-lg shadow-lg">
                Analisar E-mail
            </button>
        </form>

        {% if error %}
        <div class="error-box bg-red-900/40 border-l-4 border-red-500 text-red-200 p-4 rounded-lg backdrop-blur-sm"
            role="alert">
            <p class="font-bold">Ocorreu um Erro</p>
            <p>{{ error }}</p> </div>
        {% endif %}

        {% if result_label %}
        <div class="result-box space-y-6 pt-6 border-t border-gray-700">
            <h2 class="text-2xl font-bold text-center text-gray-100 drop-shadow">Resultados da An√°lise</h2>

            <div class="bg-gray-900/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                <h3 class="font-semibold text-lg mb-2 text-gray-100">Classifica√ß√£o do E-mail:</h3>
                <div class="flex items-center space-x-3">
                    {% if result_label == 'Produtivo' %}
                    <span class="px-3 py-1 text-sm font-medium bg-green-600/30 text-green-400 rounded-full">{{
                        result_label }}</span>
                    {% else %}
                    <span class="px-3 py-1 text-sm font-medium bg-yellow-600/30 text-yellow-400 rounded-full">{{
                        result_label }}</span>
                    {% endif %}
                    <span class="text-sm text-gray-400">(Confian√ßa: {{ (confidence*100)|round(1) }}%)</span>
                </div>
                <div class="mt-3">
                    <span class="text-sm text-gray-300">Confian√ßa do modelo:</span>
                    <div class="w-full bg-gray-700 rounded-full h-5 overflow-hidden mt-1">
                        <div class="h-full rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center"
                            style="width: {{ (confidence * 100)|round(1) }}%;">
                            <span class="text-xs font-bold text-white">{{ (confidence * 100)|round(1) }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-lg text-gray-100">Resposta Autom√°tica Sugerida:</h3>
                    <button type="button" id="copyBtn"
                        class="text-sm bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-1 px-3 rounded-lg hover:opacity-90 transition">
                        Copiar
                    </button>
                </div>
                <p id="suggested_reply_text" class="text-gray-200 whitespace-pre-wrap">{{ suggested_reply }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        /*
         * Esta se√ß√£o cont√©m todo o c√≥digo JavaScript respons√°vel pela interatividade da p√°gina,
         * como manipula√ß√£o de formul√°rios, feedback ao usu√°rio e chamadas ass√≠ncronas.
         */

        // --- VERIFICA√á√ÉO DE CHAVES DE AMBIENTE VINDAS DO BACKEND ---
        /*
         * As vari√°veis 'GEMINI_KEY_EXISTS' e 'OPENAI_KEY_EXISTS' s√£o injetadas aqui pelo Flask.
         * O filtro `|tojson` garante que o booleano Python (True/False) seja convertido
         * para um booleano JavaScript (true/false) de forma segura, evitando erros de sintaxe.
         * Isso nos permite saber no frontend se as chaves de API j√° est√£o configuradas no servidor.
         */
        const GEMINI_KEY_EXISTS = {{ gemini_key_exists| tojson }};
        const OPENAI_KEY_EXISTS = {{ openai_key_exists| tojson }};

        // --- L√ìGICA PARA MOSTRAR/ESCONDER CAMPO DE API KEY ---
        /*
         * Esta fun√ß√£o controla a visibilidade do campo de input da chave de API
         * com base no modelo de IA selecionado e se a chave j√° existe no servidor.
         */
        const modeSelector = document.getElementById('mode');
        const apiKeyWrapper = document.getElementById('api_key_wrapper');

        function toggleApiKeyField() {
            const selectedValue = modeSelector.value;

            // Passo 1: Determina se o campo DEVERIA aparecer com base apenas no modelo selecionado.
            // Ele deve aparecer para 'gemini' ou 'openai'.
            let shouldShow = (selectedValue === 'gemini' || selectedValue === 'openai');

            // Passo 2: Refina a decis√£o. Se o campo deveria aparecer, verificamos se a chave
            // correspondente j√° existe no servidor (usando as vari√°veis injetadas).
            // Se a chave j√° existir, mudamos a decis√£o para 'n√£o mostrar'.
            if (shouldShow) {
                if (selectedValue === 'gemini' && GEMINI_KEY_EXISTS) {
                    shouldShow = false; // A chave do Gemini j√° existe no servidor, ent√£o esconde o campo.
                }
                if (selectedValue === 'openai' && OPENAI_KEY_EXISTS) {
                    shouldShow = false; // A chave do OpenAI j√° existe no servidor, ent√£o esconde o campo.
                }
            }

            // Passo 3: Aplica a decis√£o final ao estilo do elemento, mostrando ou escondendo-o.
            apiKeyWrapper.style.display = shouldShow ? 'block' : 'none';
        }

        // Adiciona um 'ouvinte de eventos' que chama a fun√ß√£o sempre que o usu√°rio muda a sele√ß√£o.
        modeSelector.addEventListener('change', toggleApiKeyField);
        // Chama a fun√ß√£o uma vez quando a p√°gina carrega para definir o estado inicial correto.
        document.addEventListener('DOMContentLoaded', toggleApiKeyField);


        // --- L√ìGICA DO BOT√ÉO DE COPIAR ---
        /*
         * Esta se√ß√£o implementa a funcionalidade de "copiar para a √°rea de transfer√™ncia".
         */
        const copyBtn = document.getElementById('copyBtn');

        // Verifica se o bot√£o de c√≥pia existe na p√°gina (ele s√≥ existe se houver um resultado).
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                const replyText = document.getElementById('suggested_reply_text').innerText;

                // Usa a API do Navegador 'Clipboard' para escrever o texto na √°rea de transfer√™ncia.
                navigator.clipboard.writeText(replyText).then(() => {
                    // Sucesso: Muda o texto do bot√£o para dar feedback ao usu√°rio.
                    copyBtn.textContent = 'Copiado!';
                    // Volta o texto para 'Copiar' ap√≥s 2 segundos.
                    setTimeout(() => {
                        copyBtn.textContent = 'Copiar';
                    }, 2000);
                }).catch(err => {
                    // Erro: Loga o erro no console e informa o usu√°rio.
                    console.error('Erro ao copiar texto: ', err);
                    copyBtn.textContent = 'Erro!';
                });
            });
        }

        // --- L√ìGICA PARA PREVIEW DE ARQUIVO ---
        /*
         * Gerencia a sele√ß√£o de arquivos, fornecendo feedback ao usu√°rio e
         * pr√©-carregando o conte√∫do de arquivos .txt na √°rea de texto principal.
         */
        const fileInput = document.getElementById('file_input');
        const textInput = document.getElementById('text_input');
        const fileFeedback = document.getElementById('file_feedback');
        const fileNameDisplay = document.getElementById('file_name_display');

        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];

            // Se o usu√°rio cancelou a sele√ß√£o, limpa o feedback e o nome do arquivo.
            if (!file) {
                fileFeedback.textContent = '';
                fileNameDisplay.textContent = 'Nenhum ficheiro selecionado';
                return;
            }

            // Atualiza a UI para mostrar o nome do arquivo selecionado.
            fileNameDisplay.textContent = file.name;
            const fileName = file.name.toLowerCase();

            // Se for um arquivo .txt, l√™ seu conte√∫do e o insere na √°rea de texto.
            if (fileName.endsWith('.txt')) {
                const reader = new FileReader();

                // Quando a leitura for conclu√≠da com sucesso.
                reader.onload = function (e) {
                    textInput.value = e.target.result; // Coloca o conte√∫do do arquivo no textarea.
                    fileFeedback.textContent = `Conte√∫do de '${file.name}' carregado.`;
                };
                // Em caso de erro na leitura.
                reader.onerror = function () {
                    fileFeedback.textContent = `Erro ao ler o arquivo '${file.name}'.`;
                };
                reader.readAsText(file); // Inicia a leitura do arquivo como texto.

            } else if (fileName.endsWith('.pdf')) {
                // Se for um .pdf, apenas informa ao usu√°rio que ele ser√° processado no servidor.
                textInput.value = ''; // Limpa a √°rea de texto.
                fileFeedback.textContent =
                    `Arquivo PDF '${file.name}' selecionado. O conte√∫do ser√° lido no servidor.`;

            } else {
                // Se for um tipo de arquivo inv√°lido.
                fileFeedback.textContent = 'Por favor, selecione um arquivo .txt ou .pdf.';
                fileNameDisplay.textContent = 'Nenhum ficheiro selecionado';
                fileInput.value = ''; // Reseta o input de arquivo.
            }
        });
    </script>
</body>

</html>