<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classificador de Emails - AutoU</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Seus estilos originais foram mantidos aqui */
    body {
      font-family: 'Inter', sans-serif;
    }

    .result-box,
    .error-box {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #api_key_wrapper {
      display: none;
    }

    /* Animação blobs */
    @keyframes blob {
      0% { transform: scale(1) translate(0px, 0px); }
      33% { transform: scale(1.1) translate(30px, -50px); }
      66% { transform: scale(0.9) translate(-20px, 20px); }
      100% { transform: scale(1) translate(0px, 0px); }
    }

    /* Estrelas piscando */
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    /* Reflexo sutil no card */
    .card-glass::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 35%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.15), transparent);
      border-radius: inherit;
      pointer-events: none;
    }
  </style>
</head>

<body
  class="bg-gradient-to-br from-gray-900 via-gray-950 to-black text-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6 overflow-hidden relative">

  <div class="absolute inset-0 w-full h-full z-0 overflow-hidden">
    <div class="absolute top-0 -left-10 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-purple-600 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-[blob_28s_infinite]"></div>
    <div class="absolute top-0 -right-10 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-blue-500 rounded-full mix-blend-screen filter blur-3xl opacity-20 animate-[blob_30s_infinite_reverse]"></div>
    <div class="absolute bottom-0 left-20 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-cyan-500 rounded-full mix-blend-screen filter blur-3xl opacity-15 animate-[blob_34s_infinite]"></div>
    <div class="absolute bottom-0 right-20 w-80 h-80 md:w-[30rem] md:h-[30rem] bg-indigo-600 rounded-full mix-blend-screen filter blur-3xl opacity-15 animate-[blob_32s_infinite]"></div>
    </div>

  <div
    class="w-full max-w-2xl bg-white/10 backdrop-blur-xl rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.6)] p-6 sm:p-8 space-y-8 border border-white/20 relative z-20 card-glass">

    <header class="text-center space-y-2">
      <h1
        class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 drop-shadow-lg">
        Classificador de Emails
      </h1>
      <p class="text-gray-300 drop-shadow">Uma simulação do Case Prático AutoU 🚀</p>
    </header>

    <form action="/process" method="POST" enctype="multipart/form-data" class="space-y-6">
      
      <div>
        <label for="text_input" class="block text-sm font-medium text-gray-200 mb-1">Cole o texto do e-mail
          aqui:</label>
        <textarea id="text_input" name="text_input" rows="8"
          class="w-full p-3 rounded-lg border border-gray-700 bg-gray-900/60 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 placeholder-gray-400"
          placeholder="Ex: Olá, gostaria de saber o status do meu pedido 12345.">{{ original_text or '' }}</textarea>
      </div>

      <div class="relative flex items-center">
        <div class="flex-grow border-t border-gray-600"></div>
        <span class="flex-shrink mx-4 text-gray-400 text-sm">OU</span>
        <div class="flex-grow border-t border-gray-600"></div>
      </div>

      <div>
        <label for="file_input" class="block text-sm font-medium text-gray-200 mb-1">Envie um arquivo (.txt ou .pdf):</label>
        <input type="file" id="file_input" name="file" accept=".txt,.pdf"
          class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg 
            file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-blue-600 file:to-purple-600 file:text-white hover:file:opacity-90 transition">
        <p id="file_feedback" class="text-xs text-gray-400 mt-1 h-4"></p>
      </div>

      <div class="grid sm:grid-cols-2 gap-4 items-end">
        
        <div>
          <label for="mode" class="block text-sm font-medium text-gray-200 mb-1">Escolha o modelo de IA:</label>
          <select id="mode" name="mode"
            class="w-full p-3 border border-gray-700 bg-gray-900/60 rounded-lg text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <option value="local" {% if selected_mode == 'local' or not selected_mode %}selected{% endif %}>Modelo Local (Rápido e Offline)</option>
            <option value="gemini" {% if selected_mode == 'gemini' %}selected{% endif %}>Google Gemini</option>
            <option value="openai" {% if selected_mode == 'openai' %}selected{% endif %}>OpenAI GPT</option>
          </select>
        </div>

        <div id="api_key_wrapper">
          <label for="api_key" class="block text-sm font-medium text-gray-200 mb-1">Chave de API:</label>
          <input type="password" id="api_key" name="api_key"
            class="w-full p-3 border border-gray-700 bg-gray-900/60 rounded-lg text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            placeholder="Cole sua chave de API aqui">
        </div>
      </div>

      <button type="submit"
        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg 
        hover:opacity-90 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition duration-150 text-lg shadow-lg">
        Analisar E-mail
      </button>
    </form>

    {% if error %}
    <div class="error-box bg-red-900/40 border-l-4 border-red-500 text-red-200 p-4 rounded-lg backdrop-blur-sm"
      role="alert">
      <p class="font-bold">Ocorreu um Erro</p>
      <p>{{ error }}</p>
    </div>
    {% endif %}

    {% if result_label %}
    <div class="result-box space-y-6 pt-6 border-t border-gray-700">
      <h2 class="text-2xl font-bold text-center text-gray-100 drop-shadow">Resultados da Análise</h2>

      <div class="bg-gray-900/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
        <h3 class="font-semibold text-lg mb-2 text-gray-100">Classificação do E-mail:</h3>
        <div class="flex items-center space-x-3">
          {% if result_label == 'Produtivo' %}
          <span class="px-3 py-1 text-sm font-medium bg-green-600/30 text-green-400 rounded-full">{{ result_label }}</span>
          {% else %}
          <span class="px-3 py-1 text-sm font-medium bg-yellow-600/30 text-yellow-400 rounded-full">{{ result_label }}</span>
          {% endif %}
          <span class="text-sm text-gray-400">(Confiança: {{ (confidence*100)|round(1) }}%)</span>
        </div>

        <div class="mt-3">
          <span class="text-sm text-gray-300">Confiança do modelo:</span>
          <div class="w-full bg-gray-700 rounded-full h-5 overflow-hidden mt-1">
            <div class="h-full rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center"
              style="width: {{ (confidence * 100)|round(1) }}%;">
                <span class="text-xs font-bold text-white">
                    {{ (confidence * 100)|round(1) }}%
                </span>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-gray-900/60 p-4 rounded-lg border border-gray-700 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-lg text-gray-100">Resposta Automática Sugerida:</h3>
          <button type="button" id="copyBtn"
            class="text-sm bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-1 px-3 rounded-lg hover:opacity-90 transition">
            Copiar
          </button>
        </div>
        <p id="suggested_reply_text" class="text-gray-200 whitespace-pre-wrap">{{ suggested_reply }}</p>
      </div>
    </div>
    {% endif %}

  </div>

  <script>
    // --- LÓGICA ORIGINAL: Mostrar/esconder campo de API Key ---
    const modeSelector = document.getElementById('mode');
    const apiKeyWrapper = document.getElementById('api_key_wrapper');

    function toggleApiKeyField() {
      const selectedValue = modeSelector.value;
      if (selectedValue === 'gemini' || selectedValue === 'openai') {
        apiKeyWrapper.style.display = 'block';
      } else {
        apiKeyWrapper.style.display = 'none';
      }
    }
    // Adiciona os "ouvintes" para executar a função quando a página carrega e quando o seletor muda.
    modeSelector.addEventListener('change', toggleApiKeyField);
    document.addEventListener('DOMContentLoaded', toggleApiKeyField);

    // --- LÓGICA ORIGINAL: Botão de copiar ---
    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        const replyText = document.getElementById('suggested_reply_text').innerText;
        navigator.clipboard.writeText(replyText).then(() => {
          copyBtn.textContent = 'Copiado!';
          setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 2000);
        }).catch(err => {
          console.error('Erro ao copiar texto: ', err);
          copyBtn.textContent = 'Erro!';
        });
      });
    }

    // ### INÍCIO DO INCREMENTO BUG 3: PREVIEW DE ARQUIVO ###
    // Este novo bloco de código lida com a experiência do usuário ao selecionar um arquivo.
    
    // Seleciona os elementos do HTML que vamos manipular.
    const fileInput = document.getElementById('file_input');
    const textInput = document.getElementById('text_input');
    const fileFeedback = document.getElementById('file_feedback');

    // Adiciona um "ouvinte" ao input de arquivo que dispara sempre que um arquivo é selecionado.
    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];

      // Se o usuário cancelar a seleção, limpa o feedback.
      if (!file) {
        fileFeedback.textContent = '';
        return;
      }

      const fileName = file.name.toLowerCase();
      
      // Caso 1: Se for um arquivo .txt, lê o conteúdo e o exibe na caixa de texto.
      if (fileName.endsWith('.txt')) {
        const reader = new FileReader(); // API do navegador para ler arquivos.
        
        // Define o que fazer quando a leitura for concluída com sucesso.
        reader.onload = function(e) {
          textInput.value = e.target.result; // Coloca o texto lido no textarea.
          fileFeedback.textContent = `Conteúdo de '${file.name}' carregado na caixa de texto.`;
        };
        
        // Define o que fazer em caso de erro na leitura.
        reader.onerror = function() {
          fileFeedback.textContent = `Erro ao ler o arquivo '${file.name}'.`;
        };
        
        // Inicia a operação de leitura do arquivo como texto.
        reader.readAsText(file);
      } 
      // Caso 2: Se for um .pdf, não podemos ler o conteúdo no navegador, então
      // limpamos a caixa de texto e exibimos uma mensagem informativa.
      else if (fileName.endsWith('.pdf')) {
        textInput.value = ''; // Limpa para garantir que o backend priorize o arquivo.
        fileFeedback.textContent = `Arquivo PDF '${file.name}' selecionado. O conteúdo será lido no servidor.`;
      } 
      // Caso 3: Arquivo inválido.
      else {
        fileFeedback.textContent = 'Por favor, selecione um arquivo .txt ou .pdf.';
      }
    });
    // ### FIM DO INCREMENTO BUG 3 ###
  </script>

</body>
</html>